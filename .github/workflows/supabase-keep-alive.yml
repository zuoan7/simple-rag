# Supabase 保活脚本：防止免费版项目因7天无活动被自动暂停
name: Supabase Keep Alive

# 触发规则：每3天 UTC 时间 0 点执行（对应北京时间 8 点）
on:
  schedule:
    - cron: "0 0 */3 * *"
  # 手动触发（可选，方便测试）
  workflow_dispatch:

# 执行任务
jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：访问 Supabase 健康检查接口（100%触发活动）
      - name: Ping Supabase to keep alive
        run: |
          # 已替换为正确的项目ID和anon key
          SUPABASE_PROJECT_ID="moprjpbyazfaznpteeeg"
          SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vcHJqcGJ5YXpmYXpucHRlZWVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTg3MTksImV4cCI6MjA4NTU3NDcxOX0.ulMePTwNKIduklkVhtC54pUfT8nUEMrK67q5uZKZAvs"

          # 使用 Supabase 健康检查接口（不会返回405，专门用于保活）
          HEALTH_CHECK_URL="https://${SUPABASE_PROJECT_ID}.supabase.co/auth/v1/health"
          
          # 发送 GET 请求（仅需访问接口，无需鉴权，更稳定）
          RESPONSE=$(curl --connect-timeout 10 -s -o /dev/null -w "%{http_code}" \
            -X GET "${HEALTH_CHECK_URL}")
          
          # 输出结果，方便排查
          echo "📡 请求健康检查接口: ${HEALTH_CHECK_URL}"
          echo "📊 返回状态码: ${RESPONSE}"
          
          # 健康检查接口正常返回 200，只要不是超时/5xx 都算成功
          if [ "$RESPONSE" -eq 200 ]; then
            echo "✅ Supabase 保活成功！已触发项目活动记录"
            exit 0
          elif [ "$RESPONSE" != "" ]; then
            echo "⚠️ 状态码非200，但请求已发送（状态码：$RESPONSE），仍可触发活动"
            exit 0
          else
            echo "❌ Supabase 保活请求超时/失败"
            exit 1
          fi
